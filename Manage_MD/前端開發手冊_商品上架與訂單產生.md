# 前端開發手冊 - 商品上架與訂單產生

## 文檔概述

本手冊針對 Shopro 電商平台的前端開發，詳細說明「商品上架」與「訂單產生」兩大核心業務流程。
文檔遵循「業務邏輯 → 後端接口」的說明方式，幫助開發人員理解功能需求並正確實現前端代碼。

**技術棧**：
- 前端：Vue 3 + TypeScript + Quasar Framework + Pinia
- 後端：Spring Boot + Microsoft SQL Server
- 通信：RESTful API (Axios)

---

## 目錄

1. [商品上架流程](#一商品上架流程)
2. [訂單產生流程](#二訂單產生流程)
3. [API 使用範例](#三api-使用範例)
4. [常見問題與最佳實踐](#四常見問題與最佳實踐)

---

## 一、商品上架流程

### 1.1 業務邏輯說明

商品上架是電商平台的核心功能之一，完整流程包含以下步驟：

#### 業務流程圖
```
1. 創建商品基本資訊
   ↓
2. 添加商品圖片（主圖、詳情圖）
   ↓
3. 設置商品規格（如顏色、尺寸）
   ↓
4. 設置商品標籤（如「熱賣」、「新品」）
   ↓
5. 設置分類和庫存
   ↓
6. 預覽並確認
   ↓
7. 執行上架操作（狀態變更為 ACTIVE）
   ↓
8. 商品在前台商城展示
```

#### 業務規則
- **狀態管理**：
  - `DRAFT`：草稿狀態，商品尚未完成編輯
  - `ACTIVE`：已上架，客戶可見並可購買
  - `INACTIVE`：已下架，客戶不可見
  - `OUT_OF_STOCK`：缺貨狀態，暫時無法購買

- **必填欄位**：
  - 商品名稱（name）
  - 商品價格（basePrice, salePrice）
  - 銷售模式（salesMode）：NORMAL（一般商品）、PRE_ORDER（預購）、SUBSCRIPTION（訂閱）、VOUCHER（優惠券）

- **驗證規則**：
  - SKU 必須全局唯一（如果填寫）
  - 價格必須 >= 0
  - 最小購買數量 >= 1
  - 商品名稱最多 200 字元
  - 必須先創建分類才能指定 categoryId

---

### 1.2 後端接口調用流程

#### 步驟 1：創建商品

**業務邏輯**：新建商品並保存基本資訊，初始狀態為 `DRAFT`。

**後端接口**：
- **端點**：`POST /api/products`
- **請求格式**：
```json
{
  "name": "經典白T恤",
  "sku": "SKU001",
  "description": "100% 純棉材質，舒適透氣",
  "categoryId": 1,
  "salesMode": "NORMAL",
  "basePrice": 499.00,
  "salePrice": 399.00,
  "costPrice": 200.00,
  "weight": 200,
  "minPurchaseQuantity": 1,
  "maxPurchaseQuantity": 10,
  "sortOrder": 1,
  "enabled": true
}
```

**回應格式**：
```json
{
  "success": true,
  "message": "商品已創建",
  "data": {
    "id": 1,
    "name": "經典白T恤",
    "sku": "SKU001",
    "status": "DRAFT",
    ...
  }
}
```

**前端實現**：
```typescript
// 位置：frontend/src/api/product.ts
import { productApi } from '@/api'

const createProduct = async (productData) => {
  try {
    const response = await productApi.createProduct(productData)
    if (response.success) {
      console.log('商品創建成功：', response.data)
      return response.data.id // 返回商品 ID 用於後續操作
    }
  } catch (error) {
    console.error('創建商品失敗：', error)
  }
}
```

---

#### 步驟 2：添加商品圖片

**業務邏輯**：為商品添加主圖和詳情圖，至少需要一張主圖。

**後端接口**：
- **端點**：`POST /api/product-images`
- **請求格式**：
```json
{
  "productId": 1,
  "imageUrl": "https://example.com/image1.jpg",
  "imageType": "MAIN",
  "sortOrder": 1,
  "isPrimary": true
}
```

**批量添加圖片範例**：
```typescript
const addProductImages = async (productId: number, images: string[]) => {
  const imagePromises = images.map((imageUrl, index) => {
    return axios.post('/api/product-images', {
      productId,
      imageUrl,
      imageType: index === 0 ? 'MAIN' : 'DETAIL',
      sortOrder: index + 1,
      isPrimary: index === 0
    })
  })
  
  await Promise.all(imagePromises)
  console.log('所有圖片已添加完成')
}
```

**相關接口**：
- 設置主圖：`PUT /api/product-images/{id}/set-primary`
- 獲取商品圖片：`GET /api/product-images/product/{productId}`
- 刪除圖片：`DELETE /api/product-images/{id}`

---

#### 步驟 3：設置商品規格

**業務邏輯**：為商品添加多種規格（如不同顏色、尺寸），每個規格有獨立的 SKU、價格和庫存。

**後端接口**：
- **端點**：`POST /api/product-specifications`
- **請求格式**：
```json
{
  "productId": 1,
  "specName": "顏色:紅色,尺寸:L",
  "sku": "SKU001-RED-L",
  "price": 399.00,
  "cost": 200.00,
  "stock": 100,
  "image": "https://example.com/red-l.jpg",
  "weight": 200,
  "enabled": true
}
```

**批量創建規格**：
```typescript
// 批量創建規格
const createSpecifications = async (productId: number) => {
  const specifications = [
    { specName: '顏色:紅色,尺寸:L', sku: 'SKU001-RED-L', price: 399.00, stock: 100 },
    { specName: '顏色:藍色,尺寸:L', sku: 'SKU001-BLUE-L', price: 399.00, stock: 80 },
    { specName: '顏色:紅色,尺寸:XL', sku: 'SKU001-RED-XL', price: 429.00, stock: 60 }
  ]
  
  const response = await axios.post('/api/product-specifications/batch', 
    specifications.map(spec => ({ productId, ...spec }))
  )
  
  return response.data
}
```

**相關接口**：
- 批量創建：`POST /api/product-specifications/batch`
- 更新規格：`PUT /api/product-specifications/{id}`
- 獲取商品規格：`GET /api/product-specifications/product/{productId}`

---

#### 步驟 4：設置商品標籤

**業務邏輯**：為商品添加標籤（如「熱賣」、「新品」、「限時優惠」），用於商品分類和營銷展示。

**後端接口**：
- **端點**：`PUT /api/product-tags/product/{productId}`
- **請求格式**：
```json
[1, 2, 3, 5]
```

**前端實現**：
```typescript
const setProductTags = async (productId: number, tagIds: number[]) => {
  await axios.put(`/api/product-tags/product/${productId}`, tagIds)
  console.log('標籤已設置')
}

// 使用範例
await setProductTags(1, [1, 2, 3]) // 為商品 ID=1 設置標籤 1, 2, 3
```

**相關接口**：
- 創建標籤：`POST /api/product-tags`
- 獲取所有標籤：`GET /api/product-tags`
- 獲取商品標籤：`GET /api/product-tags/product/{productId}`

---

#### 步驟 5：上架商品

**業務邏輯**：將商品狀態從 `DRAFT` 變更為 `ACTIVE`，使商品在前台商城可見並可購買。

**後端接口**：
- **端點**：`PUT /api/products/{id}/activate`
- **回應格式**：
```json
{
  "success": true,
  "message": "商品已上架",
  "data": {
    "id": 1,
    "status": "ACTIVE",
    ...
  }
}
```

**前端實現**：
```typescript
const activateProduct = async (productId: number) => {
  try {
    const response = await productApi.activateProduct(productId)
    if (response.success) {
      $q.notify({
        type: 'positive',
        message: '商品已成功上架'
      })
    }
  } catch (error) {
    $q.notify({
      type: 'negative',
      message: '上架失敗，請稍後再試'
    })
  }
}
```

**相關操作**：
- 下架商品：`PUT /api/products/{id}/deactivate`
- 批量上架：`POST /api/product-batch/activate`（請求體：`[1, 2, 3]`）
- 批量下架：`POST /api/product-batch/deactivate`

---

### 1.3 完整流程範例代碼

```typescript
// frontend/src/views/ProductView.vue
import { ref } from 'vue'
import { useQuasar } from 'quasar'
import { productApi } from '@/api'
import axios from '@/api/axios'

const $q = useQuasar()

// 完整的商品上架流程
const createAndPublishProduct = async () => {
  try {
    // 步驟 1: 創建商品
    const productData = {
      name: '經典白T恤',
      sku: 'SKU001',
      description: '100% 純棉材質，舒適透氣',
      categoryId: 1,
      salesMode: 'NORMAL',
      basePrice: 499.00,
      salePrice: 399.00,
      enabled: true
    }
    
    const createResponse = await productApi.createProduct(productData)
    const productId = createResponse.data.id
    
    // 步驟 2: 添加商品圖片
    const images = [
      'https://example.com/main.jpg',
      'https://example.com/detail1.jpg',
      'https://example.com/detail2.jpg'
    ]
    
    for (let i = 0; i < images.length; i++) {
      await axios.post('/api/product-images', {
        productId,
        imageUrl: images[i],
        imageType: i === 0 ? 'MAIN' : 'DETAIL',
        sortOrder: i + 1,
        isPrimary: i === 0
      })
    }
    
    // 步驟 3: 批量創建規格
    const specifications = [
      { specName: '顏色:紅色,尺寸:L', sku: 'SKU001-RED-L', price: 399.00, stock: 100 },
      { specName: '顏色:藍色,尺寸:L', sku: 'SKU001-BLUE-L', price: 399.00, stock: 80 }
    ]
    
    await axios.post('/api/product-specifications/batch',
      specifications.map(spec => ({ productId, ...spec }))
    )
    
    // 步驟 4: 設置標籤
    await axios.put(`/api/product-tags/product/${productId}`, [1, 2, 3])
    
    // 步驟 5: 上架商品
    await productApi.activateProduct(productId)
    
    $q.notify({
      type: 'positive',
      message: '商品已成功創建並上架！'
    })
    
    return productId
    
  } catch (error) {
    console.error('商品上架流程失敗：', error)
    $q.notify({
      type: 'negative',
      message: '操作失敗，請檢查錯誤日誌'
    })
  }
}
```

---

## 二、訂單產生流程

### 2.1 業務邏輯說明

訂單產生是客戶下單購買商品的完整流程，包含以下步驟：

#### 業務流程圖
```
1. 客戶選擇商品並添加到購物車
   ↓
2. 確認商品規格、數量
   ↓
3. 填寫收貨地址和聯絡資訊
   ↓
4. 選擇配送方式（宅配/門市取貨）
   ↓
5. 計算訂單金額（商品金額 - 折扣 + 運費）
   ↓
6. 確認訂單並提交
   ↓
7. 創建訂單（狀態：PENDING_PAYMENT）
   ↓
8. 客戶選擇支付方式並完成支付
   ↓
9. 更新訂單狀態為 PROCESSING
   ↓
10. 後台處理訂單並發貨
   ↓
11. 訂單完成（COMPLETED）
```

#### 訂單狀態流轉
```
PENDING_PAYMENT (待付款)
   ↓
PROCESSING (處理中)
   ↓
SHIPPED (已發貨)
   ↓
DELIVERED (已送達)
   ↓
COMPLETED (已完成)

或者：
CANCELLED (已取消)
REFUNDED (已退款)
```

#### 業務規則
- **訂單編號**：系統自動生成唯一訂單編號
- **黑名單檢查**：創建訂單前檢查客戶是否在黑名單中
- **庫存檢查**：確保商品有足夠庫存
- **金額計算**：
  ```
  totalAmount = subtotalAmount - discountAmount + shippingFee
  ```
- **配送方式**：
  - `DELIVERY`：宅配到府
  - `STORE_PICKUP`：門市取貨
  - `CROSS_STORE_PICKUP`：跨店取貨

---

### 2.2 後端接口調用流程

#### 步驟 1：檢查客戶黑名單

**業務邏輯**：在創建訂單前，檢查客戶是否在黑名單中。

**後端接口**：
- **端點**：`GET /api/orders/blacklist/check/{customerId}`
- **回應格式**：
```json
{
  "success": true,
  "data": {
    "isBlacklisted": false,
    "reason": null
  }
}
```

**前端實現**：
```typescript
const checkCustomerBlacklist = async (customerId: number) => {
  const response = await axios.get(`/api/orders/blacklist/check/${customerId}`)
  
  if (response.data.isBlacklisted) {
    $q.notify({
      type: 'negative',
      message: `該客戶已被列入黑名單：${response.data.reason}`
    })
    return false
  }
  
  return true
}
```

---

#### 步驟 2：計算訂單金額

**業務邏輯**：根據商品價格、數量、折扣和運費計算訂單總金額。

**前端實現**：
```typescript
interface OrderItem {
  productId: number
  productName: string
  productSku: string
  unitPrice: number
  quantity: number
  discountAmount: number
}

const calculateOrderAmount = (
  items: OrderItem[], 
  shippingFee: number = 60, 
  orderDiscountAmount: number = 0
) => {
  // 計算商品小計
  const subtotalAmount = items.reduce((sum, item) => {
    return sum + (item.unitPrice * item.quantity)
  }, 0)
  
  // 計算商品折扣總額
  const itemDiscountAmount = items.reduce((sum, item) => {
    return sum + (item.discountAmount || 0)
  }, 0)
  
  // 總折扣 = 商品折扣 + 訂單折扣
  const totalDiscountAmount = itemDiscountAmount + orderDiscountAmount
  
  // 訂單總金額 = 小計 - 折扣 + 運費
  const totalAmount = subtotalAmount - totalDiscountAmount + shippingFee
  
  return {
    subtotalAmount,
    discountAmount: totalDiscountAmount,
    shippingFee,
    totalAmount: Math.max(0, totalAmount) // 確保不為負數
  }
}
```

---

#### 步驟 3：創建訂單

**業務邏輯**：提交訂單資料並創建新訂單，初始狀態為 `PENDING_PAYMENT`。

**後端接口**：
- **端點**：`POST /api/orders`
- **請求格式**：
```json
{
  "customerId": 1,
  "customerName": "張三",
  "customerPhone": "0912345678",
  "customerEmail": "test@example.com",
  "status": "PENDING_PAYMENT",
  "pickupType": "DELIVERY",
  "subtotalAmount": 1000.00,
  "discountAmount": 100.00,
  "shippingFee": 60.00,
  "totalAmount": 960.00,
  "shippingAddress": "台北市信義區信義路五段7號",
  "isDraft": false,
  "items": [
    {
      "productId": 1,
      "productName": "經典白T恤",
      "productSku": "SKU001-RED-L",
      "unitPrice": 500.00,
      "quantity": 2,
      "subtotalAmount": 1000.00,
      "discountAmount": 0.00,
      "actualAmount": 1000.00
    }
  ]
}
```

**回應格式**：
```json
{
  "success": true,
  "message": "訂單已創建",
  "data": {
    "id": 1,
    "orderNumber": "ORD20241226001",
    "status": "PENDING_PAYMENT",
    ...
  }
}
```

**前端實現**：
```typescript
import { orderApi, type Order, type OrderItem } from '@/api'

const createOrder = async (orderData: Order) => {
  try {
    // 1. 檢查客戶黑名單
    const canCreateOrder = await checkCustomerBlacklist(orderData.customerId!)
    if (!canCreateOrder) {
      return null
    }
    
    // 2. 計算訂單金額
    const amounts = calculateOrderAmount(
      orderData.items!,
      orderData.shippingFee || 60,
      orderData.discountAmount || 0
    )
    
    // 3. 組合完整訂單資料
    const completeOrderData = {
      ...orderData,
      ...amounts,
      status: 'PENDING_PAYMENT',
      isDraft: false
    }
    
    // 4. 提交訂單
    const response = await orderApi.createOrder(completeOrderData)
    
    if (response.success) {
      $q.notify({
        type: 'positive',
        message: '訂單已成功創建！'
      })
      
      return response.data
    }
  } catch (error) {
    console.error('創建訂單失敗：', error)
    $q.notify({
      type: 'negative',
      message: '訂單創建失敗，請稍後再試'
    })
  }
}
```

---

#### 步驟 4：創建付款記錄

**業務邏輯**：客戶完成支付後，創建付款記錄並更新付款狀態。

**後端接口**：
- **端點**：`POST /api/orders/payments`
- **請求格式**：
```json
{
  "orderId": 1,
  "paymentStatus": "PAID",
  "paymentMethod": "信用卡",
  "paymentAmount": 960.00,
  "paymentTime": "2024-12-26T10:30:00",
  "transactionId": "TXN123456789"
}
```

**前端實現**：
```typescript
const createPaymentRecord = async (orderId: number, paymentData: any) => {
  const response = await axios.post('/api/orders/payments', {
    orderId,
    ...paymentData
  })
  
  if (response.data.success) {
    console.log('付款記錄已創建')
    return response.data
  }
}
```

**相關接口**：
- 更新付款狀態：`PATCH /api/orders/payments/{paymentId}/status`
- 申請退款：`POST /api/orders/payments/{paymentId}/refund`
- 查詢付款記錄：`GET /api/orders/payments/order/{orderId}`

---

#### 步驟 5：更新訂單狀態

**業務邏輯**：根據訂單處理進度更新訂單狀態。

**後端接口**：
- **端點**：`PATCH /api/orders/{id}/status?status={newStatus}`
- **狀態值**：
  - `PENDING_PAYMENT`：待付款
  - `PROCESSING`：處理中
  - `SHIPPED`：已發貨
  - `DELIVERED`：已送達
  - `COMPLETED`：已完成
  - `CANCELLED`：已取消
  - `REFUNDED`：已退款

**前端實現**：
```typescript
const updateOrderStatus = async (orderId: number, status: string) => {
  try {
    const response = await orderApi.updateOrderStatus(orderId, status)
    
    if (response.success) {
      $q.notify({
        type: 'positive',
        message: `訂單狀態已更新為：${getStatusLabel(status)}`
      })
    }
  } catch (error) {
    $q.notify({
      type: 'negative',
      message: '狀態更新失敗'
    })
  }
}

// 狀態標籤映射
const getStatusLabel = (status: string) => {
  const statusMap: Record<string, string> = {
    'PENDING_PAYMENT': '待付款',
    'PROCESSING': '處理中',
    'SHIPPED': '已發貨',
    'DELIVERED': '已送達',
    'COMPLETED': '已完成',
    'CANCELLED': '已取消',
    'REFUNDED': '已退款'
  }
  return statusMap[status] || status
}
```

---

#### 步驟 6：創建物流記錄

**業務邏輯**：訂單發貨時創建物流記錄，記錄物流公司和追蹤號碼。

**後端接口**：
- **端點**：`POST /api/orders/shipments`
- **請求格式**：
```json
{
  "orderId": 1,
  "shippingStatus": "SHIPPED",
  "shippingCompany": "黑貓宅急便",
  "trackingNumber": "123456789",
  "recipientName": "張三",
  "recipientPhone": "0912345678",
  "recipientAddress": "台北市信義區信義路五段7號",
  "estimatedDeliveryDate": "2024-12-28"
}
```

**前端實現**：
```typescript
const createShipmentRecord = async (orderId: number, shipmentData: any) => {
  const response = await axios.post('/api/orders/shipments', {
    orderId,
    shippingStatus: 'SHIPPED',
    ...shipmentData
  })
  
  if (response.data.success) {
    // 同時更新訂單狀態為已發貨
    await updateOrderStatus(orderId, 'SHIPPED')
    
    $q.notify({
      type: 'positive',
      message: '物流記錄已創建，訂單已發貨'
    })
  }
}
```

**相關接口**：
- 更新物流狀態：`PATCH /api/orders/shipments/{shipmentId}/status`
- 更新追蹤號碼：`PATCH /api/orders/shipments/{shipmentId}/tracking`
- 查詢物流記錄：`GET /api/orders/shipments/order/{orderId}`
- 物流追蹤：`GET /api/orders/shipments/tracking/{trackingNumber}`

---

### 2.3 完整流程範例代碼

```typescript
// frontend/src/views/OrderView.vue
import { ref } from 'vue'
import { useQuasar } from 'quasar'
import { orderApi, type Order, type OrderItem } from '@/api'
import axios from '@/api/axios'

const $q = useQuasar()

// 完整的訂單創建流程
const createCompleteOrder = async () => {
  try {
    // 訂單資料
    const orderData: Order = {
      customerId: 1,
      customerName: '張三',
      customerPhone: '0912345678',
      customerEmail: 'test@example.com',
      pickupType: 'DELIVERY',
      shippingAddress: '台北市信義區信義路五段7號',
      items: [
        {
          productId: 1,
          productName: '經典白T恤',
          productSku: 'SKU001-RED-L',
          unitPrice: 500.00,
          quantity: 2,
          subtotalAmount: 1000.00,
          discountAmount: 0.00,
          actualAmount: 1000.00
        }
      ]
    }
    
    // 步驟 1: 檢查黑名單
    const canCreate = await checkCustomerBlacklist(orderData.customerId)
    if (!canCreate) return
    
    // 步驟 2: 計算金額
    const amounts = calculateOrderAmount(orderData.items, 60, 100)
    
    // 步驟 3: 創建訂單
    const createResponse = await orderApi.createOrder({
      ...orderData,
      ...amounts,
      status: 'PENDING_PAYMENT'
    })
    
    const orderId = createResponse.data.id
    const orderNumber = createResponse.data.orderNumber
    
    console.log(`訂單已創建：${orderNumber}`)
    
    // 步驟 4: 創建付款記錄（模擬客戶付款）
    await createPaymentRecord(orderId, {
      paymentStatus: 'PAID',
      paymentMethod: '信用卡',
      paymentAmount: amounts.totalAmount,
      paymentTime: new Date().toISOString(),
      transactionId: `TXN${Date.now()}`
    })
    
    // 步驟 5: 更新訂單狀態為處理中
    await updateOrderStatus(orderId, 'PROCESSING')
    
    // 步驟 6: 創建物流記錄（模擬發貨）
    await createShipmentRecord(orderId, {
      shippingCompany: '黑貓宅急便',
      trackingNumber: `TRACK${Date.now()}`,
      recipientName: orderData.customerName,
      recipientPhone: orderData.customerPhone,
      recipientAddress: orderData.shippingAddress,
      estimatedDeliveryDate: '2024-12-28'
    })
    
    $q.notify({
      type: 'positive',
      message: '訂單流程已完成！',
      caption: `訂單編號：${orderNumber}`
    })
    
    return { orderId, orderNumber }
    
  } catch (error) {
    console.error('訂單創建流程失敗：', error)
    $q.notify({
      type: 'negative',
      message: '操作失敗，請檢查錯誤日誌'
    })
  }
}
```

---

## 三、API 使用範例

### 3.1 商品管理常用操作

#### 查詢商品列表
```typescript
// 獲取所有商品（分頁）
const fetchProducts = async (page = 0, size = 20) => {
  const response = await productApi.getProducts({ page, size })
  return response.data
}

// 按分類查詢商品
const fetchProductsByCategory = async (categoryId: number) => {
  const response = await axios.get(`/api/products/category/${categoryId}`, {
    params: { page: 0, size: 20 }
  })
  return response.data
}

// 按狀態查詢商品
const fetchProductsByStatus = async (status: string) => {
  const response = await axios.get(`/api/products/status/${status}`, {
    params: { page: 0, size: 20 }
  })
  return response.data
}

// 搜尋商品
const searchProducts = async (keyword: string) => {
  const response = await axios.get('/api/products/search', {
    params: { keyword, page: 0, size: 20 }
  })
  return response.data
}
```

#### 獲取商品詳情
```typescript
// 獲取商品完整資訊（含圖片、標籤、規格）
const getProductDetails = async (productId: number) => {
  // 基本資訊
  const productRes = await productApi.getProduct(productId)
  const product = productRes.data
  
  // 圖片
  const imagesRes = await axios.get(`/api/product-images/product/${productId}`)
  product.images = imagesRes.data
  
  // 標籤
  const tagsRes = await axios.get(`/api/product-tags/product/${productId}`)
  product.tags = tagsRes.data
  
  // 規格
  const specsRes = await axios.get(`/api/product-specifications/product/${productId}`)
  product.specifications = specsRes.data
  
  return product
}
```

#### 批量操作
```typescript
// 批量上架商品
const batchActivateProducts = async (productIds: number[]) => {
  await axios.post('/api/product-batch/activate', productIds)
  $q.notify({ type: 'positive', message: '批量上架成功' })
}

// 批量下架商品
const batchDeactivateProducts = async (productIds: number[]) => {
  await axios.post('/api/product-batch/deactivate', productIds)
  $q.notify({ type: 'positive', message: '批量下架成功' })
}

// 批量刪除商品
const batchDeleteProducts = async (productIds: number[]) => {
  await axios.post('/api/product-batch/delete', productIds)
  $q.notify({ type: 'positive', message: '批量刪除成功' })
}
```

---

### 3.2 訂單管理常用操作

#### 查詢訂單
```typescript
// 獲取所有訂單（分頁）
const fetchOrders = async (page = 0, size = 20) => {
  const response = await orderApi.getOrders({ page, size })
  return response.data
}

// 按客戶查詢訂單
const fetchOrdersByCustomer = async (customerId: number) => {
  const response = await axios.get(`/api/orders/customer/${customerId}`, {
    params: { page: 0, size: 20 }
  })
  return response.data
}

// 按狀態查詢訂單
const fetchOrdersByStatus = async (status: string) => {
  const response = await axios.get(`/api/orders/status/${status}`, {
    params: { page: 0, size: 20 }
  })
  return response.data
}

// 按訂單編號查詢
const fetchOrderByNumber = async (orderNumber: string) => {
  const response = await axios.get(`/api/orders/search/order-number/${orderNumber}`)
  return response.data
}
```

#### 多條件搜尋
```typescript
// 多條件查詢訂單
const searchOrders = async (criteria: any) => {
  const response = await axios.post('/api/orders/search', {
    customerId: criteria.customerId,
    status: criteria.status,
    startDate: criteria.startDate,
    endDate: criteria.endDate,
    minAmount: criteria.minAmount,
    maxAmount: criteria.maxAmount,
    page: criteria.page || 0,
    size: criteria.size || 20
  })
  return response.data
}

// 使用範例
const results = await searchOrders({
  status: 'COMPLETED',
  startDate: '2024-01-01T00:00:00',
  endDate: '2024-12-31T23:59:59',
  minAmount: 500,
  maxAmount: 5000
})
```

#### 批量操作
```typescript
// 批量更新訂單狀態
const batchUpdateOrderStatus = async (orderIds: number[], targetStatus: string) => {
  await axios.put('/api/orders/batch/status', {
    orderIds,
    targetStatus,
    operatorId: 100,
    operatorName: '管理員',
    notes: '批次處理訂單'
  })
  $q.notify({ type: 'positive', message: '批量更新成功' })
}

// 批量刪除訂單
const batchDeleteOrders = async (orderIds: number[]) => {
  await axios.delete('/api/orders/batch', { data: orderIds })
  $q.notify({ type: 'positive', message: '批量刪除成功' })
}
```

#### 訂單統計
```typescript
// 獲取今日統計
const getTodayStatistics = async () => {
  const response = await axios.get('/api/orders/statistics/today')
  return response.data
}

// 獲取本週統計
const getWeekStatistics = async () => {
  const response = await axios.get('/api/orders/statistics/week')
  return response.data
}

// 獲取本月統計
const getMonthStatistics = async () => {
  const response = await axios.get('/api/orders/statistics/month')
  return response.data
}

// 獲取完整統計數據（含圖表）
const getFullStatistics = async () => {
  const response = await axios.get('/api/orders/statistics')
  return response.data
  // 包含：每日訂單趨勢、金額分布、狀態占比、每日金額趨勢
}
```

---

### 3.3 分類管理

```typescript
// 獲取所有分類
const fetchCategories = async () => {
  const response = await axios.get('/api/product-categories')
  return response.data
}

// 獲取已啟用的分類
const fetchEnabledCategories = async () => {
  const response = await axios.get('/api/product-categories/enabled')
  return response.data
}

// 獲取頂層分類
const fetchTopCategories = async () => {
  const response = await axios.get('/api/product-categories/top')
  return response.data
}

// 獲取子分類
const fetchChildCategories = async (parentId: number) => {
  const response = await axios.get(`/api/product-categories/${parentId}/children`)
  return response.data
}

// 建立分類樹
const buildCategoryTree = async () => {
  const topCategories = await fetchTopCategories()
  
  for (const category of topCategories) {
    category.children = await fetchChildCategories(category.id)
  }
  
  return topCategories
}
```

---

## 四、常見問題與最佳實踐

### 4.1 錯誤處理

#### 統一錯誤處理機制
```typescript
// frontend/src/api/axios.ts
import axios from 'axios'
import { useQuasar } from 'quasar'

const $q = useQuasar()

// 回應攔截器
axios.interceptors.response.use(
  (response) => {
    // 檢查業務邏輯錯誤
    if (response.data && !response.data.success) {
      $q.notify({
        type: 'negative',
        message: response.data.message || '操作失敗'
      })
      return Promise.reject(new Error(response.data.message))
    }
    return response.data // 返回 data 部分
  },
  (error) => {
    // HTTP 錯誤處理
    const status = error.response?.status
    const message = error.response?.data?.message || '系統錯誤'
    
    if (status === 401) {
      $q.notify({ type: 'negative', message: '請先登入' })
      // 跳轉到登入頁
    } else if (status === 403) {
      $q.notify({ type: 'negative', message: '無權限執行此操作' })
    } else if (status === 404) {
      $q.notify({ type: 'negative', message: '資源不存在' })
    } else {
      $q.notify({ type: 'negative', message })
    }
    
    return Promise.reject(error)
  }
)
```

#### 常見錯誤訊息處理
```typescript
const handleApiError = (error: any, operation: string) => {
  console.error(`${operation} 失敗：`, error)
  
  // 根據錯誤訊息給出友好提示
  const errorMessage = error.response?.data?.message || error.message
  
  const errorMap: Record<string, string> = {
    '商品不存在': '找不到該商品，可能已被刪除',
    '商品編號（SKU）已存在，請使用其他編號': '商品編號重複，請更換',
    '標籤名稱已存在': '標籤名稱已被使用',
    '規格編號（SKU）已存在': '規格編號重複',
    '該客戶已被列入黑名單': '無法為該客戶創建訂單',
    '庫存不足': '商品庫存不足，無法完成訂單'
  }
  
  const friendlyMessage = errorMap[errorMessage] || errorMessage
  
  $q.notify({
    type: 'negative',
    message: friendlyMessage,
    caption: operation
  })
}
```

---

### 4.2 表單驗證

```typescript
// 商品表單驗證規則
const productFormRules = {
  name: [
    (val: string) => !!val || '請輸入商品名稱',
    (val: string) => val.length <= 200 || '商品名稱不可超過 200 字元'
  ],
  sku: [
    (val: string) => !val || val.length <= 50 || 'SKU 不可超過 50 字元'
  ],
  basePrice: [
    (val: number) => val >= 0 || '價格不可為負數',
    (val: number) => !isNaN(val) || '請輸入有效的數字'
  ],
  salePrice: [
    (val: number) => val >= 0 || '售價不可為負數',
    (val: number, form: any) => val <= form.basePrice || '售價不可高於原價'
  ],
  minPurchaseQuantity: [
    (val: number) => val >= 1 || '最小購買數量至少為 1'
  ]
}

// 訂單表單驗證規則
const orderFormRules = {
  customerName: [
    (val: string) => !!val || '請輸入客戶姓名'
  ],
  customerPhone: [
    (val: string) => !!val || '請輸入聯絡電話',
    (val: string) => /^09\d{8}$/.test(val) || '請輸入有效的手機號碼'
  ],
  customerEmail: [
    (val: string) => !val || /.+@.+\..+/.test(val) || '請輸入有效的電子郵件'
  ],
  shippingAddress: [
    (val: string) => !!val || '請輸入收貨地址',
    (val: string) => val.length >= 10 || '地址至少需要 10 個字元'
  ],
  items: [
    (val: any[]) => val && val.length > 0 || '訂單至少需要一個商品'
  ]
}
```

---

### 4.3 性能優化建議

#### 使用分頁查詢
```typescript
// ❌ 不好的做法：一次載入所有數據
const loadAllProducts = async () => {
  const response = await productApi.getProducts()
  products.value = response.data
}

// ✅ 好的做法：使用分頁
const loadProducts = async (page = 0, size = 20) => {
  loading.value = true
  try {
    const response = await productApi.getProducts({ page, size })
    products.value = response.content
    totalElements.value = response.totalElements
    totalPages.value = response.totalPages
  } finally {
    loading.value = false
  }
}
```

#### 使用防抖和節流
```typescript
import { debounce } from 'quasar'

// 搜尋輸入防抖
const searchQuery = ref('')
const debouncedSearch = debounce(async (keyword: string) => {
  const results = await searchProducts(keyword)
  products.value = results.content
}, 500) // 500ms 延遲

watch(searchQuery, (newValue) => {
  if (newValue) {
    debouncedSearch(newValue)
  }
})
```

#### 批量操作優化
```typescript
// ✅ 使用批量接口
const deleteMultipleProducts = async (productIds: number[]) => {
  // 使用批量刪除接口
  await axios.post('/api/product-batch/delete', productIds)
}

// ❌ 避免逐個刪除
const deleteMultipleProductsBad = async (productIds: number[]) => {
  // 每個商品都發一次請求，效率低
  for (const id of productIds) {
    await productApi.deleteProduct(id)
  }
}
```

---

### 4.4 狀態管理最佳實踐

#### 使用 Pinia 管理全局狀態
```typescript
// stores/product.ts
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { productApi } from '@/api'

export const useProductStore = defineStore('product', () => {
  const products = ref<Product[]>([])
  const categories = ref<ProductCategory[]>([])
  const loading = ref(false)
  
  // 計算屬性
  const activeProducts = computed(() => 
    products.value.filter(p => p.status === 'ACTIVE')
  )
  
  // 操作方法
  const fetchProducts = async (params?: any) => {
    loading.value = true
    try {
      const response = await productApi.getProducts(params)
      products.value = response.data
    } finally {
      loading.value = false
    }
  }
  
  const fetchCategories = async () => {
    const response = await axios.get('/api/product-categories')
    categories.value = response.data
  }
  
  return {
    products,
    categories,
    loading,
    activeProducts,
    fetchProducts,
    fetchCategories
  }
})
```

#### 在組件中使用
```vue
<script setup lang="ts">
import { onMounted } from 'vue'
import { useProductStore } from '@/stores/product'

const productStore = useProductStore()

onMounted(async () => {
  await productStore.fetchProducts()
  await productStore.fetchCategories()
})
</script>

<template>
  <div v-if="productStore.loading">載入中...</div>
  <div v-else>
    <div v-for="product in productStore.activeProducts" :key="product.id">
      {{ product.name }}
    </div>
  </div>
</template>
```

---

### 4.5 UI/UX 最佳實踐

#### 使用 Loading 狀態
```vue
<template>
  <q-btn 
    :loading="submitting" 
    @click="handleSubmit"
    color="primary"
  >
    提交訂單
    <template v-slot:loading>
      <q-spinner-dots />
    </template>
  </q-btn>
</template>

<script setup lang="ts">
const submitting = ref(false)

const handleSubmit = async () => {
  submitting.value = true
  try {
    await createOrder(orderData)
  } finally {
    submitting.value = false
  }
}
</script>
```

#### 使用確認對話框
```typescript
import { useQuasar } from 'quasar'

const $q = useQuasar()

const confirmDelete = (productId: number) => {
  $q.dialog({
    title: '確認刪除',
    message: '確定要刪除此商品嗎？此操作無法復原。',
    cancel: true,
    persistent: true
  }).onOk(async () => {
    await productApi.deleteProduct(productId)
    $q.notify({ type: 'positive', message: '商品已刪除' })
    await fetchProducts() // 重新載入列表
  })
}
```

#### 友好的錯誤提示
```typescript
// ✅ 好的錯誤提示
$q.notify({
  type: 'negative',
  message: '上架失敗：商品圖片未設置',
  caption: '請至少添加一張商品主圖',
  actions: [
    { 
      label: '前往設置', 
      color: 'white',
      handler: () => { showImageDialog.value = true }
    }
  ]
})

// ❌ 不好的錯誤提示
$q.notify({
  type: 'negative',
  message: 'Error: null pointer exception'
})
```

---

### 4.6 安全性注意事項

#### 輸入驗證
```typescript
// 清理用戶輸入
const sanitizeInput = (input: string): string => {
  return input
    .trim()
    .replace(/<script[^>]*>.*?<\/script>/gi, '') // 移除 script 標籤
    .replace(/<[^>]+>/g, '') // 移除 HTML 標籤
}

// 使用範例
const createProduct = async (productData: Product) => {
  productData.name = sanitizeInput(productData.name)
  productData.description = sanitizeInput(productData.description)
  
  await productApi.createProduct(productData)
}
```

#### 避免敏感資訊洩露
```typescript
// ❌ 不要在前端記錄敏感資訊
console.log('用戶付款資訊：', paymentData)

// ✅ 只記錄必要的調試資訊
console.log('訂單已創建：', { orderId, orderNumber })
```

---

## 五、開發環境設置

### 5.1 前端環境
```bash
# 進入前端目錄
cd frontend

# 安裝依賴
npm install

# 啟動開發伺服器
npm run dev

# 訪問：http://localhost:5173
```

### 5.2 後端環境
```bash
# 進入後端目錄
cd E-commerce

# 使用 Maven 啟動
./mvnw spring-boot:run

# 後端運行在：http://localhost:8080
# Swagger 文檔：http://localhost:8080/swagger-ui/index.html
```

### 5.3 環境變量配置
```typescript
// frontend/.env.development
VITE_API_BASE_URL=http://localhost:8080/api

// frontend/.env.production
VITE_API_BASE_URL=https://your-domain.com/api
```

---

## 六、參考資源

### 官方文檔
- **產品模組 API 文檔**：`產品模組API文檔.md`
- **訂單管理模組 API 文檔**：`訂單管理模組API文檔.md`
- **前端 README**：`frontend/README.md`
- **Swagger UI**：`http://localhost:8080/swagger-ui/index.html`

### 技術文檔
- [Vue 3 官方文檔](https://vuejs.org/)
- [Quasar Framework](https://quasar.dev/)
- [TypeScript 官方文檔](https://www.typescriptlang.org/)
- [Pinia 狀態管理](https://pinia.vuejs.org/)
- [Axios HTTP 客戶端](https://axios-http.com/)

---

## 七、更新日誌

### v1.0.0 (2024-12-26)
- 初始版本發布
- 完整的商品上架流程說明
- 完整的訂單產生流程說明
- API 使用範例
- 最佳實踐指南

---

## 附錄：快速參考表

### 商品狀態對照表
| 狀態 | 說明 | 客戶可見 | 可購買 |
|------|------|---------|--------|
| DRAFT | 草稿 | ❌ | ❌ |
| ACTIVE | 已上架 | ✅ | ✅ |
| INACTIVE | 已下架 | ❌ | ❌ |
| OUT_OF_STOCK | 缺貨 | ✅ | ❌ |

### 訂單狀態對照表
| 狀態 | 說明 | 可取消 | 可退款 |
|------|------|--------|--------|
| PENDING_PAYMENT | 待付款 | ✅ | ❌ |
| PROCESSING | 處理中 | ✅ | ✅ |
| SHIPPED | 已發貨 | ❌ | ✅ |
| DELIVERED | 已送達 | ❌ | ✅ |
| COMPLETED | 已完成 | ❌ | ❌ |
| CANCELLED | 已取消 | ❌ | ❌ |
| REFUNDED | 已退款 | ❌ | ❌ |

### API 端點快速索引

#### 商品相關
- 創建商品：`POST /api/products`
- 更新商品：`PUT /api/products/{id}`
- 獲取商品：`GET /api/products/{id}`
- 刪除商品：`DELETE /api/products/{id}`
- 上架商品：`PUT /api/products/{id}/activate`
- 下架商品：`PUT /api/products/{id}/deactivate`
- 查詢商品：`GET /api/products?page={page}&size={size}`
- 搜尋商品：`GET /api/products/search?keyword={keyword}`

#### 訂單相關
- 創建訂單：`POST /api/orders`
- 更新訂單：`PUT /api/orders/{id}`
- 獲取訂單：`GET /api/orders/{id}`
- 更新狀態：`PATCH /api/orders/{id}/status?status={status}`
- 查詢訂單：`GET /api/orders?page={page}&size={size}`
- 多條件搜尋：`POST /api/orders/search`

#### 圖片相關
- 添加圖片：`POST /api/product-images`
- 設置主圖：`PUT /api/product-images/{id}/set-primary`
- 獲取圖片：`GET /api/product-images/product/{productId}`

#### 規格相關
- 添加規格：`POST /api/product-specifications`
- 批量創建：`POST /api/product-specifications/batch`
- 獲取規格：`GET /api/product-specifications/product/{productId}`

#### 標籤相關
- 設置標籤：`PUT /api/product-tags/product/{productId}`
- 獲取標籤：`GET /api/product-tags/product/{productId}`

---

**文檔維護**：本文檔由 Shopro 開發團隊維護，最後更新時間：2024-12-26

如有任何問題或建議，請聯絡開發團隊或提交 Issue。
